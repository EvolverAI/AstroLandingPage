---
// Reusable Cards Section component
import Card from "./Card.astro";
import { getEntry } from "astro:content";

export interface CardData {
    title: string;
    description: string;
    badges?: Array<{ text: string; color: string; tooltip?: string }>;
    icon?: string;
    features?: string[];
    linkText?: string;
    linkUrl?: string;
    buttonText?: string;
    buttonUrl?: string;
    buttonColor?: string;
}

export interface Props {
    // Section identification
    sectionId: string;
    sectionType?: string;

    // Content
    title: string;
    description?: string;
    cards: CardData[];
    buttonText?: string;
    buttonUrl?: string;
    buttonColor?: string;

    // Layout
    columns?: string;
    responsiveColumns?: {
        mobile?: string;
        tablet?: string;
        desktop?: string;
    };

    // Styling
    theme?: string;
    backgroundColor?: string;
    cardTheme?: string;
    iconColor?: string;
    centerCards?: boolean;
    customClasses?: string;

    // Localization
    language?: string;
    languageFile?: string; // Override for specific language files (e.g., "elysia-en")
    environment?: string;
}

const {
    sectionId,
    sectionType = sectionId,
    title,
    description,
    cards,
    buttonText,
    buttonUrl,
    buttonColor = "bg-blue-600 hover:bg-blue-700",
    columns = "4",
    responsiveColumns,
    theme = "dark",
    backgroundColor = "bg-custom-slate",
    cardTheme,
    iconColor,
    centerCards = true,
    customClasses = "",
    language = "en",
    languageFile, // New prop for specifying exact language file
    environment = "production",
} = Astro.props;

// Try to get localized content if available
let localizedTitle = title;
let localizedDescription = description;
let localizedCards = cards;
let localizedButtonText = buttonText;
let localizedButtonUrl = buttonUrl;
let localizedButtonColor = buttonColor;
let localizedResponsiveColumns = responsiveColumns; // Add this line

try {
    // Use languageFile if provided, otherwise fall back to language
    const langFileName = languageFile || language;
    const langData = await getEntry("languages", langFileName);
    const localizedSections = langData?.data?.sections || {};

    if (localizedSections[sectionType]) {
        const sectionData = localizedSections[sectionType];
        localizedTitle = sectionData.title || title;
        localizedDescription = sectionData.description || description;
        localizedCards = sectionData.cards || cards;
        localizedButtonText = sectionData.buttonText || buttonText;
        localizedButtonUrl = sectionData.buttonUrl || buttonUrl;
        localizedButtonColor = sectionData.buttonColor || buttonColor;
        localizedResponsiveColumns =
            sectionData.responsiveColumns || responsiveColumns; // Add this line
    }
} catch (error) {
    console.warn("Localization not available for section:", sectionType, error);
}

// Normalize description text by removing extra whitespace and newlines
// Handle all types of newlines and whitespace characters
localizedDescription = localizedDescription
    ? String(localizedDescription)
          .replace(/\r\n|\r|\n/g, " ") // Replace all newline variations
          .replace(/\s+/g, " ") // Replace multiple spaces with single space
          .trim()
    : "";

// Normalize card descriptions as well
localizedCards = localizedCards.map((card) => ({
    ...card,
    description: card.description
        ? String(card.description)
              .replace(/\r\n|\r|\n/g, " ") // Replace all newline variations
              .replace(/\s+/g, " ") // Replace multiple spaces with single space
              .trim()
        : "",
}));

// Generate responsive grid classes
const defaultResponsive = {
    mobile: "1",
    tablet: columns === "4" ? "2" : columns === "3" ? "2" : columns,
    desktop: columns,
};

const responsive = { ...defaultResponsive, ...localizedResponsiveColumns };

const gridClasses = `grid grid-cols-${responsive.mobile} md:grid-cols-${responsive.tablet} xl:grid-cols-${responsive.desktop} gap-6`;

// Final card theme (inherit from section if not specified)
const finalCardTheme = cardTheme || theme;

// Title styling based on theme
const titleClasses = theme === "dark" ? "text-white" : "text-gray-800";

const descriptionClasses = theme === "dark" ? "text-gray-300" : "text-gray-600";
---

<section
    id={sectionId}
    class={`relative ${backgroundColor} py-12 ${customClasses}`}
    data-section={sectionType}
    data-theme={theme}
>
    <div
        class="container mx-auto px-4 flex flex-col justify-start items-start h-full relative z-10 mb-8"
    >
        <h1 class={`h1-noto-sans mb-4 ${titleClasses}`}>{localizedTitle}</h1>
        {
            localizedDescription && (
                <p
                    class={`${descriptionClasses} text-lg max-w-full mb-6 leading-relaxed`}
                >
                    {localizedDescription}
                </p>
            )
        }
        {
            localizedButtonText && localizedButtonUrl && (
                <a
                    href={localizedButtonUrl}
                    class={`inline-block ${localizedButtonColor} text-white py-3 px-6 rounded-lg transition duration-300`}
                >
                    {localizedButtonText}
                </a>
            )
        }
    </div>
    <div class="container mx-auto px-4">
        <div class={gridClasses}>
            {
                localizedCards.map((card) => (
                    <Card
                        title={card.title}
                        description={card.description}
                        badges={card.badges}
                        icon={card.icon}
                        features={card.features}
                        linkText={card.linkText}
                        linkUrl={card.linkUrl}
                        buttonText={card.buttonText}
                        buttonUrl={card.buttonUrl}
                        buttonColor={card.buttonColor}
                        theme={finalCardTheme}
                        iconColor={iconColor}
                        centerContent={centerCards}
                    />
                ))
            }
        </div>
    </div>

    <!-- Development helper -->
    {
        import.meta.env.DEV && (
            <details class="container mx-auto px-4 mt-8 bg-black bg-opacity-75 text-white p-4 rounded text-xs">
                <summary class="cursor-pointer">
                    {sectionType} Cards Debug
                </summary>
                <pre class="mt-2 overflow-auto">
                    {JSON.stringify(
                        {
                            sectionId,
                            sectionType,
                            title: localizedTitle,
                            cardsCount: localizedCards.length,
                            theme,
                            cardTheme: finalCardTheme,
                            language,
                        },
                        null,
                        2,
                    )}
                </pre>
            </details>
        )
    }
</section>
