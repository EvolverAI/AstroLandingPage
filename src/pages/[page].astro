---
// Page redirector - catches /pagename and redirects to /{lang}/pagename

export async function getStaticPaths() {
    const AVAILABLE_PAGES = ["b2b", "wfm", "elysia", "courses"];
    const paths: any[] = [];

    // Generate paths for all available pages without language prefix
    AVAILABLE_PAGES.forEach((page) => {
        paths.push({
            params: { page: page },
            props: { pageName: page },
        });
    });

    return paths;
}

const { page } = Astro.params;
const { pageName } = Astro.props;

console.log(
    "ðŸ”€ Page redirector - Page:",
    page,
    "Redirecting to language version",
);
---

<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EvolverAI - Redirecting...</title>
        <meta
            name="description"
            content={`Redirecting to ${pageName} page in your preferred language`}
        />
        <style>
            body {
                font-family: system-ui, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                color: white;
            }
            .loader {
                text-align: center;
            }
            .spinner {
                border: 3px solid #374151;
                border-top: 3px solid #3b82f6;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="loader">
            <div class="spinner"></div>
            <p>Redirecting to {pageName} page in your preferred language...</p>
        </div>

        <script define:vars={{ pageName }}>
            function redirectToLanguagePage() {
                const supportedLanguages = ["en", "de", "it"];
                let targetLanguage = localStorage.getItem(
                    "userLanguagePreference",
                );

                if (!targetLanguage) {
                    // Detect browser language
                    const browserLang =
                        navigator.language || navigator.languages[0];
                    const langCode = browserLang.split("-")[0].toLowerCase();
                    if (supportedLanguages.includes(langCode)) {
                        targetLanguage = langCode;
                    } else {
                        targetLanguage = "en";
                    }
                    // Save detected/default language in localStorage
                    localStorage.setItem(
                        "userLanguagePreference",
                        targetLanguage,
                    );
                }

                // Redirect to appropriate language page, preserving hash and query params
                const hash = window.location.hash || "";
                const search = window.location.search || "";
                const redirectPath = `/${targetLanguage}/${pageName}${search}${hash}`;

                console.log(`ðŸ”€ Redirecting /${pageName} â†’ ${redirectPath}`);

                setTimeout(() => {
                    window.location.href = redirectPath;
                }, 500);
            }

            document.addEventListener(
                "DOMContentLoaded",
                redirectToLanguagePage,
            );
        </script>
    </body>
</html>
